# https://github.com/cilium/cilium/tree/main/install/kubernetes/cilium
# https://docs.cilium.io/en/stable/helm-reference/
cilium:
  #debug:
  #  enabled: true

  # if kube-proxy is disabled and cilium should take over
  kubeProxyReplacement: true

  # needed as the default is a cluster internal ip that does not work without kube-proxy
  #   -> https://github.com/cilium/cilium/issues/19038
  # works as long as either all nodes are part of the control plane or forward the respective port (depends on k8s distribution)
  k8sServiceHost: localhost
  k8sServicePort: 6443

  # L2 announcements (https://docs.cilium.io/en/stable/network/l2-announcements/#l2-announcements)
  # Enable L2 announcements to have Cilium announce external or load balancer IPs via ARP/ND
  l2announcements:
    enabled: true
  # Enable neighbor discovery to allow Cilium to learn MAC addresses of nodes for L2 announcements
  l2NeighDiscovery:
    enabled: true
  # TODO?
  #k8sClientRateLimit:
    #qps:
    #burst:

  # Required for L2 announcements to work when accessing services via nodes that don't run the target pod
  bpf:
    masquerade: true

  #nodeIPAM:
    #enabled: false  # replacement for metallb??

  operator:
    replicas: 1

  ipv6:
    enabled: true

  hubble:
    enabled: true
    relay:
      enabled: true
    tls:
      auto:
        # Prevent sync loop with argocd: https://github.com/cilium/cilium/issues/14550
        # TODO: could be changed to certmanager?
        method: "cronJob"
    ui:
      enabled: true
      ingress:
        enabled: true
        annotations:
          traefik.ingress.kubernetes.io/router.middlewares: "traefik-common-internal-access-allowlist@kubernetescrd"
