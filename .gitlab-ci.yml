include:
  - component: $CI_SERVER_FQDN/to-be-continuous/helm/gitlab-ci-helm@8.2.0
    inputs:
      repos: ""
      publish-on: protected
      publish-strategy: manual
      chart-dir: "03_apps/charts/application-wrapper"
      publish-url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/release"


helm-lint:
  rules:
    - if: '$HELM_LINT_DISABLED == "true"'
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /helm:publish/
    - exists:
        - "$HELM_CHART_DIR/Chart.yaml"
      changes:
        - "$HELM_CHART_DIR/**/*"

helm-package:
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /helm:publish/
    - exists:
        - "$HELM_CHART_DIR/Chart.yaml"
      changes:
        - "$HELM_CHART_DIR/**/*"


helm-publish:
  rules:
    - if: '$HELM_PUBLISH_URL == null || $HELM_PUBLISH_URL == "" || $HELM_PUBLISH_METHOD == "disabled"'
      when: never
    - if: '$HELM_PUBLISH_ON == "protected" && $CI_COMMIT_REF_PROTECTED != "true"'
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /helm:publish/
    - if: '$HELM_PUBLISH_STRATEGY == "manual"'
      changes:
        - "$HELM_CHART_DIR/Chart.yaml"
      exists:
        - "$HELM_CHART_DIR/Chart.yaml"
      when: manual
    - if: '$HELM_PUBLISH_STRATEGY == "auto"'
      changes:
        - "$HELM_CHART_DIR/Chart.yaml"
      exists:
        - "$HELM_CHART_DIR/Chart.yaml"

